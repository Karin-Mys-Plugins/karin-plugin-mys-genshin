name: Publish Preview # å‘å¸ƒé¢„è§ˆç‰ˆæœ¬çš„å·¥ä½œæµç¨‹åç§°

on:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened

permissions:
  contents: read
  pull-requests: write # éœ€è¦å†™æƒé™ä»¥ä¾¿è¯„è®º PR

jobs:
  preview:
    runs-on: ubuntu-latest
    steps:
      # æ£€å‡ºä»£ç 
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # è·å–å®Œæ•´çš„ git å†å²ä»¥ä¾¿ç”Ÿæˆæ­£ç¡®çš„ç‰ˆæœ¬å·

      # è®¾ç½® Node.js ç¯å¢ƒ
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: npm install --frozen-lockfile

      # ä¿®æ”¹ç‰ˆæœ¬å·ä¸ºé¢„è§ˆç‰ˆæœ¬
      - name: Update version for preview
        run: |
          # è·å–å½“å‰ç‰ˆæœ¬å·
          $currentVersion = (Get-Content package.json | ConvertFrom-Json).version
          # è·å– PR ç¼–å·
          $prNumber = "${{ github.event.pull_request.number }}"
          # è·å–æäº¤çš„çŸ­ SHA
          $shortSha = "${{ github.event.pull_request.head.sha }}".Substring(0, 7)
          # ç”Ÿæˆé¢„è§ˆç‰ˆæœ¬å·: 1.0.23-pr.123.abc1234
          $previewVersion = "$currentVersion-pr.$prNumber.$shortSha"
          # æ›´æ–° package.json ä¸­çš„ç‰ˆæœ¬å·
          npm version $previewVersion --no-git-tag-version
          # è¾“å‡ºç‰ˆæœ¬å·ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "PREVIEW_VERSION=$previewVersion" >> $env:GITHUB_ENV
        shell: pwsh

      # ç¼–è¯‘
      - name: Build
        run: npm run build

      # ä½¿ç”¨ pkg.pr.new å‘å¸ƒé¢„è§ˆç‰ˆæœ¬
      - name: Publish to pkg.pr.new
        id: pkg-pr-new
        run: |
          npx --yes pkg-pr-new publish --json output.json --comment=off --compact --packageManager=pnpm > pkg-output.txt 2>&1

          # æå–å®é™…çš„å®‰è£…URL
          ACTUAL_INSTALL_URL=$(grep -oE 'https://pkg\.pr\.new/[^[:space:]`]+' pkg-output.txt | head -n 1 || echo "")

          if [ ! -z "$ACTUAL_INSTALL_URL" ]; then
            # å°è¯•æå–çŸ­é“¾æ¥æ ¼å¼
            if [[ "$ACTUAL_INSTALL_URL" =~ https://pkg\.pr\.new/[^/]+/[^/]+/([^/]+@.+) ]]; then
              ACTUAL_INSTALL_URL="https://pkg.pr.new/${BASH_REMATCH[1]}"
            fi
            PNPM_INSTALL_CMD="pnpm add ${ACTUAL_INSTALL_URL} -w"
          else
            PNPM_INSTALL_CMD="æœªæ‰¾åˆ°å®‰è£…å‘½ä»¤"
          fi

          # è½¬æ¢ä¸º UTC+8 æ—¶é—´
          BEIJING_TIME=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')

          echo "pnpm_install_cmd=$PNPM_INSTALL_CMD" >> $GITHUB_OUTPUT
          echo "published_time=$BEIJING_TIME" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # åœ¨ PR ä¸­è¯„è®ºé¢„è§ˆç‰ˆæœ¬ä¿¡æ¯
      - name: Comment preview info
        uses: thollander/actions-comment-pull-request@v3
        with:
          message: |
            ## ğŸš€ é¢„è§ˆåŒ…å‘å¸ƒæˆåŠŸ

            ### ğŸ·ï¸ åŒ…ä¿¡æ¯
            - **ç‰ˆæœ¬:** `${{ env.PREVIEW_VERSION }}`
            - **æäº¤:** [`${{ github.event.pull_request.head.sha }}`](https://github.com/${{ github.repository }}/commit/${{ github.event.pull_request.head.sha }})
            - **å‘å¸ƒæ—¶é—´:** `${{ steps.pkg-pr-new.outputs.published_time }}`

            ### ğŸ“¥ å®‰è£…å‘½ä»¤
            ```bash
            ${{ steps.pkg-pr-new.outputs.pnpm_install_cmd }}
            ```
          comment-tag: published-packages
          mode: upsert
          reactions: rocket
